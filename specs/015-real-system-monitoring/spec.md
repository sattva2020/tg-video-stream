# Feature Specification: Реальные данные мониторинга системы

**Feature Branch**: `015-real-system-monitoring`  
**Created**: 2025-11-30  
**Status**: Draft  
**Input**: User description: "Подключить реальные данные в блоки 'Здоровье системы' и 'Активность'"

> ⚖️ Конституция: все текстовые блоки заполняем на русском. Каждая пользовательская история
> должна быть независимой, иметь измеримые критерии успеха и ссылаться на будущие тесты и
> документацию, иначе `/speckit.plan` не пройдет гейт.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Просмотр реальных метрик здоровья системы (Priority: P1)

Администратор хочет видеть актуальные метрики здоровья сервера (CPU, RAM, диск, задержка, соединения БД), чтобы оперативно обнаруживать проблемы с производительностью и принимать меры до отказа системы.

**Why this priority**: Критически важно для проактивного мониторинга — без этого администратор узнаёт о проблемах только когда система уже упала.

**Independent Test**: Администратор открывает Dashboard, видит блок "Здоровье системы" с актуальными данными. При высокой нагрузке на сервер показатели изменяются в реальном времени. Ценность: предупреждение о проблемах до отказа.

**Acceptance Scenarios**:

1. **Given** администратор на странице Dashboard, **When** блок "Здоровье системы" загружается, **Then** отображаются реальные значения: CPU (%), RAM (%), Диск (%), Latency (ms), DB Connections (N/Max)
2. **Given** данные отображаются, **When** проходит 30 секунд, **Then** метрики автоматически обновляются без перезагрузки страницы
3. **Given** любая метрика превышает критический порог (CPU >90%, RAM >85%, Disk >90%), **When** данные обновляются, **Then** метрика подсвечивается красным цветом с предупреждением

---

### User Story 2 - Просмотр истории последних событий системы (Priority: P1)

Администратор хочет видеть ленту последних событий (регистрации, одобрения, действия с трансляцией, добавление треков), чтобы понимать активность в системе и быстро реагировать на важные события.

**Why this priority**: Критически важно для операционного управления — администратор должен видеть что происходит в системе без ручной проверки каждого раздела.

**Independent Test**: Администратор видит в блоке "Последняя активность" реальные события: новая регистрация пользователя, запуск/остановка трансляции. При новом событии оно появляется в ленте. Ценность: оперативная осведомлённость.

**Acceptance Scenarios**:

1. **Given** администратор на Dashboard, **When** блок "Последняя активность" загружается, **Then** отображаются последние 10-20 реальных событий с типом, описанием и временем
2. **Given** новый пользователь регистрируется в системе, **When** администратор обновляет Dashboard или ждёт авто-обновления, **Then** событие "Новый пользователь зарегистрировался" появляется в ленте
3. **Given** трансляция запускается/останавливается, **When** событие происходит, **Then** оно отображается в ленте активности с корректным временем

---

### User Story 3 - Индикация статуса трансляции в реальном времени (Priority: P2)

Администратор хочет видеть актуальный статус трансляции (онлайн/офлайн/ошибка) с деталями, чтобы быстро понимать работает ли стриминг и нужно ли вмешательство.

**Why this priority**: Важно для оперативного управления стримом, но менее критично чем общий мониторинг — стрим можно проверить и через Telegram.

**Independent Test**: Администратор видит статус "Онлайн" когда стрим работает, "Офлайн" когда остановлен, "Ошибка" при проблемах. Ценность: моментальное понимание состояния ключевой функции.

**Acceptance Scenarios**:

1. **Given** трансляция активна, **When** администратор открывает Dashboard, **Then** статус показывает "Онлайн" с зелёным индикатором
2. **Given** трансляция остановлена, **When** администратор открывает Dashboard, **Then** статус показывает "Офлайн" с серым индикатором
3. **Given** трансляция завершилась с ошибкой, **When** администратор открывает Dashboard, **Then** статус показывает "Ошибка" с красным индикатором и описанием проблемы

---

### User Story 4 - Фильтрация и поиск по истории событий (Priority: P3)

Администратор хочет фильтровать события по типу (регистрации, трансляция, плейлист) и искать по тексту, чтобы быстро находить нужную информацию в большом объёме данных.

**Why this priority**: Улучшение UX — базовый просмотр работает и без фильтров, но они полезны при большом количестве событий.

**Independent Test**: Администратор выбирает фильтр "Только регистрации" — в ленте остаются только события регистрации. Ценность: экономия времени при анализе.

**Acceptance Scenarios**:

1. **Given** администратор просматривает ленту активности, **When** выбирает фильтр "Регистрации", **Then** отображаются только события типа user_registered
2. **Given** фильтр "Трансляция" активен, **When** происходит регистрация нового пользователя, **Then** это событие не появляется в отфильтрованном списке
3. **Given** много событий в ленте, **When** администратор вводит поисковый запрос, **Then** отображаются только события содержащие этот текст

---

### Edge Cases

- Что происходит если сервер мониторинга недоступен? → Показывается сообщение "Данные временно недоступны" вместо метрик
- Как система обрабатывает очень старые события? → Хранятся последние 1000 событий, старые архивируются или удаляются
- Что если метрика не может быть получена (например, нет доступа к /proc на контейнере)? → Показывается "N/A" для этой метрики

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА получать и отображать реальные метрики CPU, RAM, диска с сервера
- **FR-002**: Система ДОЛЖНА измерять и отображать латентность ответа API
- **FR-003**: Система ДОЛЖНА получать количество активных соединений к базе данных
- **FR-004**: Система ДОЛЖНА записывать события: регистрация пользователя, изменение статуса, действия с трансляцией, изменения плейлиста
- **FR-005**: Система ДОЛЖНА отображать последние 20 событий (макс. 100) с пагинацией через параметры `limit` и `offset`
- **FR-006**: Система ДОЛЖНА обновлять метрики автоматически каждые 30 секунд
- **FR-007**: Система ДОЛЖНА визуально индицировать критические значения метрик (превышение порогов)
- **FR-008**: Система ДОЛЖНА отображать актуальный статус трансляции с индикатором

### Key Entities

- **SystemMetrics**: cpu_percent, ram_percent, disk_percent, latency_ms, db_connections, db_max_connections, timestamp
- **ActivityEvent**: id, type (user_registered, user_approved, stream_started, stream_stopped, track_added), message, user_email, details, created_at

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Метрики системы обновляются каждые 30 секунд с точностью ±5%
- **SC-002**: Задержка получения метрик не превышает 500ms
- **SC-003**: 100% реальных событий (регистрации, изменения трансляции) отображаются в ленте в течение 60 секунд
- **SC-004**: Администратор может определить состояние системы за менее чем 3 секунды после загрузки Dashboard
- **SC-005**: При критических значениях метрик администратор получает визуальное предупреждение

## Assumptions

- Бэкенд имеет доступ к системным метрикам (psutil или аналог для Python)
- PostgreSQL предоставляет информацию о соединениях через pg_stat_activity
- События записываются в отдельную таблицу или используется существующий механизм логирования
- Автообновление не создаёт значительную нагрузку на сервер (polling каждые 30 сек приемлем)
