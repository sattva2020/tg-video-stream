# Feature Specification: Авторизация и регистрация через Telegram

**Feature Branch**: \`013-telegram-login\`  
**Created**: 2025-11-29  
**Status**: Draft  
**Input**: User description: "добавить авторизацию и регистрацию также через Telegram"

> ⚖️ Конституция: все текстовые блоки заполняем на русском. Каждая пользовательская история
> должна быть независимой, иметь измеримые критерии успеха и ссылаться на будущие тесты и
> документацию, иначе \`/speckit.plan\` не пройдет гейт.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Вход через Telegram Login Widget (Priority: P1)

Как пользователь, я хочу войти в приложение через свой Telegram аккаунт, чтобы не создавать и не запоминать отдельные учётные данные.

**Why this priority**: Telegram — основная платформа приложения. Логично дать пользователям возможность авторизоваться через неё. Это снижает барьер входа и увеличивает конверсию регистраций.

**Independent Test**: Пользователь может нажать кнопку "Войти через Telegram", пройти авторизацию в Telegram и быть перенаправленным в приложение как авторизованный пользователь.

**Acceptance Scenarios**:

1. **Given** пользователь не авторизован и не имеет аккаунта, **When** он нажимает кнопку "Войти через Telegram" и успешно авторизуется в Telegram, **Then** в системе создаётся новый аккаунт на основе данных Telegram профиля и пользователь перенаправляется на Dashboard (\`/dashboard\`).
2. **Given** пользователь имеет существующий аккаунт, созданный через Telegram, **When** он нажимает "Войти через Telegram" и успешно авторизуется, **Then** система распознаёт его аккаунт и выполняет вход с перенаправлением на Dashboard.
3. **Given** пользователь не авторизован, **When** он нажимает "Войти через Telegram", но отменяет процесс в Telegram, **Then** пользователь остаётся на странице входа (\`/login\`) без авторизации.

---

### User Story 2 - Автоматическая регистрация при первом входе через Telegram (Priority: P1)

Как новый пользователь, я хочу, чтобы мой аккаунт автоматически создавался при первом входе через Telegram, без необходимости отдельной регистрации.

**Why this priority**: Упрощение onboarding процесса критически важно для конверсии пользователей.

**Independent Test**: Первый вход через Telegram автоматически создаёт аккаунт пользователя с его Telegram данными.

**Acceptance Scenarios**:

1. **Given** пользователь впервые входит через Telegram, **When** Telegram возвращает валидные данные профиля (ID, имя, username, фото), **Then** система создаёт новый аккаунт с этими данными и выдаёт JWT токен.
2. **Given** система создаёт новый аккаунт, **When** процесс завершён, **Then** пользователь получает полноценную сессию без дополнительных шагов верификации.

---

### User Story 3 - Выход из системы (Priority: P2)

Как авторизованный пользователь, я хочу иметь возможность выйти из приложения, чтобы безопасно завершить свою сессию.

**Why this priority**: Базовая функция безопасности, которую ожидают все пользователи.

**Independent Test**: Авторизованный пользователь может нажать кнопку "Выйти" и завершить свою сессию.

**Acceptance Scenarios**:

1. **Given** пользователь авторизован, **When** он нажимает кнопку "Выйти", **Then** его сессия завершается и он перенаправляется на страницу входа (\`/login\`).

---

### User Story 4 - Связывание Telegram с существующим аккаунтом (Priority: P2)

Как пользователь с аккаунтом через Google или email/пароль, я хочу привязать свой Telegram к существующему аккаунту, чтобы иметь возможность входить любым удобным способом.

**Why this priority**: Предотвращает создание дублирующих аккаунтов и улучшает пользовательский опыт.

**Independent Test**: Пользователь с существующим аккаунтом может подключить Telegram как дополнительный способ авторизации.

**Acceptance Scenarios**:

1. **Given** пользователь авторизован через Google/email, **When** он в настройках профиля нажимает "Подключить Telegram", **Then** открывается Telegram Login Widget для связывания аккаунтов.
2. **Given** пользователь успешно авторизовался в Telegram в режиме связывания, **When** Telegram ID ещё не привязан к другому аккаунту, **Then** система связывает Telegram ID с текущим аккаунтом пользователя.
3. **Given** Telegram ID уже привязан к другому аккаунту, **When** пользователь пытается связать его с текущим аккаунтом, **Then** система отображает сообщение "Этот Telegram аккаунт уже связан с другим аккаунтом".

---

### Edge Cases

- Что происходит, если пользователь пытается войти через Telegram с email, который уже зарегистрирован через Google/email-пароль?
  - **Решение**: Если email совпадает — предложить связать аккаунты. Если Telegram ID уже есть в системе — использовать существующий аккаунт.
- Как обрабатывается отсутствие username в Telegram?
  - **Решение**: Username опционален, система использует first_name + last_name и Telegram ID как уникальный идентификатор.
- Что делать при истечении времени валидности данных от Telegram?
  - **Решение**: Возвращать ошибку с просьбой повторить попытку авторизации.
- Что происходит при массовых регистрациях (атака ботов)?
  - **Решение**: Rate limiting по IP (5 попыток/час) + CAPTCHA при превышении порога (3 попытки за 10 минут).

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА предоставлять кнопку "Войти через Telegram" на странице входа/регистрации.
- **FR-002**: Система ДОЛЖНА использовать официальный [Telegram Login Widget](https://core.telegram.org/widgets/login) для аутентификации пользователей.
- **FR-015**: Telegram Login Widget ДОЛЖЕН открываться как popup (всплывающее окно), сохраняя контекст текущей страницы.
- **FR-003**: При первом входе через Telegram система ДОЛЖНА создать новый аккаунт пользователя с данными из Telegram профиля (telegram_id, first_name, last_name, username, photo_url).
- **FR-013**: Новый пользователь, зарегистрированный через Telegram, ДОЛЖЕН получать роль "pending" и ожидать одобрения администратором (согласно 007-user-approval).
- **FR-004**: При повторном входе система ДОЛЖНА идентифицировать пользователя по уникальному telegram_id.
- **FR-005**: Система ДОЛЖНА валидировать подпись данных от Telegram для предотвращения подделки (согласно [документации](https://core.telegram.org/widgets/login#checking-authorization)).
- **FR-012**: Система ДОЛЖНА отклонять авторизационные данные, если `auth_date` старше 5 минут (защита от replay-атак).
- **FR-006**: Система ДОЛЖНА создавать и управлять пользовательской сессией через JWT после успешного входа.
- **FR-007**: Система ДОЛЖНА предоставлять механизм выхода из системы с завершением сессии.
- **FR-008**: Система ДОЛЖНА позволять связывать Telegram с существующим аккаунтом (созданным через Google или email/пароль).
- **FR-011**: Система ДОЛЖНА позволять отвязывать Telegram от аккаунта только при наличии альтернативного способа входа (Google или email/пароль).
- **FR-019**: Система ДОЛЖНА предлагать связать аккаунты, если пользователь входит через Telegram с email, который уже зарегистрирован через Google или email/пароль.

### Управление сессиями

- **FR-009**: JWT ДОЛЖЕН храниться безопасно на клиенте (HttpOnly, Secure, SameSite=Lax cookie).
- **FR-010**: JWT ДОЛЖЕН иметь время истечения по умолчанию 24 часа (согласовано с Google Auth в specs/002-google-auth).
- **FR-014**: Система ДОЛЖНА разрешать множественные активные сессии для одного пользователя (вход с нескольких устройств одновременно).

### Защита от атак

- **FR-016**: Система ДОЛЖНА применять rate limiting на эндпоинт регистрации/входа через Telegram (максимум 5 попыток в час с одного IP).
- **FR-017**: Система ДОЛЖНА показывать CAPTCHA при превышении порога попыток регистрации (после 3 попыток с одного IP за 10 минут).
- **FR-018**: Система ДОЛЖНА логировать все подозрительные попытки регистрации для последующего анализа.

### Non-Functional Requirements

- **NFR-001**: Система ДОЛЖНА обновлять имя и фото профиля пользователя из Telegram при каждом успешном входе.
- **NFR-002**: Все API эндпоинты аутентификации ДОЛЖНЫ включать структурированное логирование для мониторинга и аудита.
- **NFR-003**: Верификация подписи Telegram ДОЛЖНА происходить на стороне бэкенда для предотвращения обхода безопасности.

### User-Facing Messages

- **При конфликте аккаунтов**: "Этот Telegram аккаунт уже связан с другим аккаунтом. Войдите через него или обратитесь в поддержку."
- **При ошибке верификации подписи**: "Ошибка авторизации. Пожалуйста, попробуйте ещё раз."
- **При истечении времени авторизации**: "Время авторизации истекло. Пожалуйста, попробуйте ещё раз."
- **При общей ошибке**: "Произошла ошибка при входе. Пожалуйста, попробуйте позже или обратитесь в поддержку."

### Key Entities *(include if feature involves data)*

- **User**: Представляет пользователя в системе.
  | Атрибут | Тип | Описание | Пример |
  |---|---|---|---|
  | \`id\` | UUID | Первичный ключ в базе данных | \`a1b2c3d4-e5f6-7890-1234-567890abcdef\` |
  | \`telegram_id\` | BigInt | Уникальный ID пользователя в Telegram | \`123456789\` |
  | \`telegram_username\` | String (nullable) | Username пользователя в Telegram | \`johndoe\` |
  | \`email\` | String (nullable) | Email пользователя (может быть пустым для Telegram-only) | \`user@example.com\` |
  | \`full_name\` | String | Полное имя пользователя | \`John Doe\` |
  | \`profile_picture_url\` | String (nullable) | URL аватара из Telegram | \`https://t.me/i/userpic/...\` |
  | \`created_at\` | DateTime | Дата создания аккаунта | \`2025-11-29T10:00:00Z\` |
  | \`updated_at\` | DateTime | Дата последнего обновления | \`2025-11-29T10:00:00Z\` |

### Application Routing

- **/login**: Публичная страница с кнопкой "Войти через Telegram".
- **/dashboard**: Главный дашборд, требует авторизации. Перенаправление после успешного входа.
- **/auth/telegram/callback**: Клиентский роут для обработки ответа от Telegram Login Widget.
- **/settings/account**: Страница настроек аккаунта для связывания Telegram с существующим аккаунтом.

## Clarifications

### Session 2025-11-30

- Q: Может ли пользователь отвязать Telegram от своего аккаунта? → A: Разрешить отвязку, только если есть другой способ входа (Google/email)
- Q: Какой допустимый интервал для auth_date от Telegram? → A: 5 минут (строгая проверка для защиты от replay-атак)
- Q: Какую роль по умолчанию получает новый пользователь через Telegram? → A: Роль "pending" с ожиданием одобрения администратором (согласовано с 007-user-approval)
- Q: Разрешены ли множественные сессии с одного Telegram аккаунта? → A: Да, разрешить множественные сессии (несколько устройств одновременно)
- Q: Как должен открываться Telegram Login Widget? → A: Popup (всплывающее окно, пользователь остаётся на странице)
- Q: Как защититься от массовых регистраций (атака ботов)? → A: Комбинация: Rate limiting по IP + CAPTCHA при превышении порога

## Assumptions

- Telegram Login Widget официально поддерживается и документирован Telegram.
- Пользователи приложения активно используют Telegram (целевая аудитория).
- Существующая инфраструктура JWT и сессий может быть расширена для Telegram авторизации.
- Bot Token для Telegram Login Widget будет настроен через переменные окружения.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Пользователи могут завершить вход через Telegram менее чем за 30 секунд.
- **SC-002**: Успешность входа через Telegram составляет не менее 99% для пользователей с валидными аккаунтами Telegram.
- **SC-003**: Введение авторизации через Telegram увеличивает общую конверсию регистраций минимум на 15% в первый месяц после запуска.
- **SC-004**: 100% попыток авторизации с невалидной подписью блокируются системой.
- **SC-005**: Пользователи могут связать Telegram с существующим аккаунтом менее чем за 60 секунд.
