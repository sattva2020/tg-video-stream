# Feature Specification: Улучшения аудио-стриминга

**Feature Branch**: `017-audio-streaming-enhancements`  
**Created**: 2025-01-20  
**Status**: Draft  
**Input**: User description: "Улучшения аудио-стриминга: скорость/pitch управление, seek/rewind, радио потоки, rate limiting, очереди с приоритетами, распознавание музыки, equalizer, i18n локализация"

## Обзор

Данная спецификация описывает комплексные улучшения системы аудио-стриминга на основе рекомендаций P1-P3 из Feature 016. Включает расширенные возможности управления воспроизведением, защиту от злоупотреблений, продвинутые аудио-функции и улучшения пользовательского опыта.

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Управление скоростью и pitch воспроизведения (Priority: P1)

Слушатель хочет регулировать скорость воспроизведения аудио (от 0.5x до 2.0x) и изменять pitch (тональность) для персонализации прослушивания подкастов, лекций или музыки.

**Why this priority**: Критически важно для пользователей, слушающих образовательный контент или аудиокниги. Позволяет экономить время при ускоренном прослушивании.

**Independent Test**: Пользователь может изменить скорость на 1.5x и услышать ускоренное воспроизведение без искажения голоса. Может сбросить на 1.0x и продолжить нормально.

**Acceptance Scenarios**:

1. **Given** аудио воспроизводится на нормальной скорости, **When** пользователь выбирает 1.5x, **Then** скорость увеличивается, а pitch корректируется для естественного звучания голоса
2. **Given** скорость установлена на 2.0x, **When** пользователь нажимает "сброс", **Then** скорость возвращается к 1.0x
3. **Given** воспроизведение на ускоренной скорости, **When** пользователь ставит паузу и возобновляет, **Then** настройка скорости сохраняется

---

### User Story 2 - Seek/Rewind навигация по треку (Priority: P1)

Слушатель хочет перематывать аудио вперед или назад на 10/30 секунд или переходить к конкретной временной метке для быстрой навигации по длинному контенту.

**Why this priority**: Базовая функциональность для любого аудиоплеера. Без неё пользователи не могут вернуться к пропущенному моменту.

**Independent Test**: Пользователь нажимает кнопку "-30 сек" и воспроизведение переходит на 30 секунд назад от текущей позиции.

**Acceptance Scenarios**:

1. **Given** трек воспроизводится на 2:00, **When** пользователь нажимает "-10 сек", **Then** позиция становится 1:50
2. **Given** трек воспроизводится на 0:05, **When** пользователь нажимает "-30 сек", **Then** позиция становится 0:00 (не уходит в отрицательные значения)
3. **Given** трек длительностью 5:00 на позиции 4:55, **When** пользователь нажимает "+30 сек", **Then** трек завершается и переходит к следующему

---

### User Story 3 - Воспроизведение радио-потоков (Priority: P1)

Слушатель хочет добавлять и воспроизводить интернет-радио потоки (HTTP/HTTPS streams) наравне с обычными аудиофайлами.

**Why this priority**: Расширяет функциональность за пределы локальных файлов. Популярная функция в современных аудиоплеерах.

**Independent Test**: Пользователь добавляет URL радиостанции, и поток начинает воспроизводиться в реальном времени.

**Acceptance Scenarios**:

1. **Given** пользователь имеет URL радио-потока, **When** добавляет его в очередь, **Then** поток начинает воспроизводиться без загрузки файла
2. **Given** радио-поток воспроизводится, **When** происходит временный разрыв соединения, **Then** система автоматически пытается переподключиться
3. **Given** радио-поток в очереди, **When** пользователь переключается на следующий трек, **Then** поток корректно останавливается

---

### User Story 4 - Rate Limiting для защиты от злоупотреблений (Priority: P1)

Система должна ограничивать количество запросов от одного пользователя для предотвращения злоупотреблений и защиты ресурсов сервера.

**Why this priority**: Критически важно для безопасности и стабильности production-системы. Предотвращает DDoS и спам.

**Independent Test**: При превышении лимита запросов пользователь получает сообщение об ограничении и не может делать новые запросы в течение определенного времени.

**Acceptance Scenarios**:

1. **Given** пользователь делает запросы в пределах лимита, **When** отправляет очередной запрос, **Then** запрос обрабатывается успешно
2. **Given** пользователь превысил лимит (100 запросов/минуту), **When** отправляет новый запрос, **Then** получает ответ с кодом 429 и временем до сброса лимита
3. **Given** пользователь заблокирован rate limiter'ом, **When** проходит период ожидания, **Then** запросы снова обрабатываются

---

### User Story 5 - Очереди с приоритетами (Priority: P2)

Администратор хочет назначать приоритеты трекам в очереди, чтобы важные объявления или запросы VIP-пользователей воспроизводились раньше.

**Why this priority**: Важно для бизнес-сценариев с разными уровнями пользователей, но не критично для базовой функциональности.

**Independent Test**: Трек с приоритетом "high" перемещается выше треков с приоритетом "normal" в очереди.

**Acceptance Scenarios**:

1. **Given** очередь содержит 5 треков с нормальным приоритетом, **When** добавляется трек с высоким приоритетом, **Then** он располагается первым в очереди
2. **Given** два трека с одинаковым приоритетом, **When** оба в очереди, **Then** порядок определяется временем добавления (FIFO)
3. **Given** VIP-пользователь добавляет трек, **When** трек добавляется, **Then** он автоматически получает повышенный приоритет

---

### User Story 6 - Предустановки эквалайзера (Priority: P2)

Слушатель хочет применять готовые предустановки эквалайзера (Rock, Jazz, Classical, Voice, Bass Boost) для улучшения качества звучания.

**Why this priority**: Улучшает пользовательский опыт, но требует значительной технической реализации на стороне аудио-процессинга.

**Independent Test**: Пользователь выбирает предустановку "Bass Boost" и слышит усиленные низкие частоты.

**Acceptance Scenarios**:

1. **Given** пользователь открывает настройки звука, **When** выбирает предустановку "Jazz", **Then** эквалайзер применяется и звук изменяется
2. **Given** применена предустановка, **When** пользователь переключается на другой трек, **Then** настройки эквалайзера сохраняются
3. **Given** пользователь изменил предустановку, **When** нажимает "Сброс", **Then** эквалайзер возвращается к нейтральным значениям

---

### User Story 7 - Запланированные плейлисты (Priority: P2)

Администратор хочет планировать воспроизведение определенных плейлистов в заданное время (утренний блок, вечерний блок, выходные).

**Why this priority**: Важно для автоматизации вещания, но требует дополнительной инфраструктуры планировщика.

**Independent Test**: Плейлист "Утренний блок" автоматически начинает воспроизводиться в 08:00 по расписанию.

**Acceptance Scenarios**:

1. **Given** администратор создал расписание на 08:00, **When** наступает 08:00, **Then** указанный плейлист автоматически загружается и начинает воспроизведение
2. **Given** расписание активно, **When** администратор отменяет его, **Then** автоматическое воспроизведение не происходит
3. **Given** активен ручной режим воспроизведения, **When** наступает время расписания, **Then** система запрашивает подтверждение переключения (или игнорирует в зависимости от настроек)

---

### User Story 8 - Отображение текста песен (Lyrics) (Priority: P2)

Слушатель хочет видеть синхронизированный текст песни во время воспроизведения для караоке-эффекта или изучения языка.

**Why this priority**: Популярная функция в музыкальных сервисах. Требует интеграции с внешними API для получения текстов.

**Independent Test**: Во время воспроизведения песни текст автоматически прокручивается синхронно с музыкой.

**Acceptance Scenarios**:

1. **Given** трек воспроизводится и текст доступен, **When** пользователь открывает вкладку "Lyrics", **Then** отображается текст с подсветкой текущей строки
2. **Given** текст не найден для трека, **When** пользователь открывает "Lyrics", **Then** отображается сообщение "Текст не найден" с возможностью добавить вручную
3. **Given** текст синхронизирован, **When** пользователь перематывает трек, **Then** подсветка текста переходит к соответствующей строке

---

### User Story 9 - Распознавание музыки (Shazam-like) (Priority: P3)

Пользователь хочет распознать неизвестный трек по аудио-сэмплу для идентификации названия и исполнителя.

**Why this priority**: Продвинутая функция, требующая интеграции с внешними сервисами (Shazam/ACRCloud). Сложная в реализации.

**Independent Test**: Пользователь нажимает "Распознать", записывается 10 секунд аудио, и система возвращает название песни.

**Acceptance Scenarios**:

1. **Given** играет неизвестный трек, **When** пользователь нажимает "Распознать", **Then** система записывает сэмпл и возвращает информацию о треке
2. **Given** распознавание запущено, **When** качество записи низкое, **Then** система сообщает о необходимости улучшить условия записи
3. **Given** трек распознан, **When** пользователь нажимает "Добавить в библиотеку", **Then** метаданные сохраняются

---

### User Story 10 - Многоязычная локализация (i18n) (Priority: P3)

Пользователи из разных стран хотят использовать интерфейс на родном языке (русский, английский, украинский, испанский).

**Why this priority**: Важно для международной аудитории, но требует значительных усилий по переводу всех строк интерфейса.

**Independent Test**: Пользователь переключает язык на украинский и весь интерфейс отображается на украинском языке.

**Acceptance Scenarios**:

1. **Given** пользователь в настройках, **When** выбирает язык "Українська", **Then** интерфейс переключается без перезагрузки страницы
2. **Given** браузер имеет установленный язык "es", **When** пользователь впервые открывает приложение, **Then** автоматически выбирается испанский язык (если доступен)
3. **Given** выбран язык без полного перевода, **When** строка не переведена, **Then** отображается fallback на английском языке

---

### User Story 11 - Поддержка нескольких каналов (Multi-channel) (Priority: P3)

Администратор хочет управлять несколькими Telegram каналами одновременно с независимыми настройками воспроизведения для каждого канала.

**Why this priority**: Расширенная функция для масштабирования. Требует значительной переработки архитектуры для изоляции состояния каналов.

**Independent Test**: Администратор запускает воспроизведение в канале 1 со скоростью 1.5x, в канале 2 со скоростью 1.0x — оба работают независимо.

**Acceptance Scenarios**:

1. **Given** настроены 2 Telegram канала, **When** администратор запускает воспроизведение в канале 1, **Then** канал 2 остаётся в исходном состоянии
2. **Given** воспроизведение идёт в обоих каналах, **When** администратор меняет эквалайзер в канале 1, **Then** настройки канала 2 не изменяются
3. **Given** администратор в панели управления, **When** выбирает канал из списка, **Then** все последующие команды применяются к выбранному каналу

---

### Edge Cases

- Что происходит при изменении скорости во время буферизации радио-потока?
- Как система обрабатывает seek в радио-потоке (невозможная операция)?
- Что происходит при одновременном rate limiting и высокоприоритетном запросе VIP-пользователя?
- Как обрабатывается конфликт между запланированным плейлистом и ручным управлением?
- Что происходит при разрыве соединения во время распознавания музыки?
- Как система обрабатывает превышение лимита каналов (максимум N каналов одновременно)?

---

## Requirements *(mandatory)*

### Functional Requirements

#### P1 - Критические (Quick Wins)

- **FR-001**: Система ДОЛЖНА поддерживать изменение скорости воспроизведения в диапазоне 0.5x - 2.0x с шагом 0.25x
- **FR-002**: Система ДОЛЖНА сохранять pitch (тональность) при изменении скорости (pitch correction)
- **FR-003**: Система ДОЛЖНА поддерживать seek (перемотку) вперед/назад на 10, 30 секунд и к произвольной временной метке
- **FR-004**: Система ДОЛЖНА поддерживать воспроизведение HTTP/HTTPS аудио-потоков (internet radio)
- **FR-005**: Система ДОЛЖНА автоматически переподключаться к радио-потоку при временном разрыве соединения (до 3 попыток)
- **FR-006**: Система ДОЛЖНА ограничивать количество API-запросов на уровне 100 запросов/минуту на пользователя
- **FR-007**: Система ДОЛЖНА возвращать HTTP 429 с заголовком Retry-After при превышении лимита
- **FR-008**: Rate limiting ДОЛЖЕН использовать Redis Fixed Window Counter (INCR + EXPIRE) для хранения счетчиков

#### P2 - Средний приоритет

- **FR-009**: Система ДОЛЖНА поддерживать 3 уровня приоритета очереди: low, normal, high
- **FR-010**: Система ДОЛЖНА предоставлять минимум 12 предустановок эквалайзера. Набор пресетов должен включать (не исчерпывающий список):
	- flat
	- rock
	- jazz
	- classical
	- voice
	- bass_boost
	- meditation
	- relax
	- new_age
	- ambient
	- sleep
	- nature
- **FR-011**: Система ДОЛЖНА позволять планировать воспроизведение плейлистов на определенное время
- **FR-012**: Система ДОЛЖНА отображать синхронизированный текст песен (если доступен)
- **FR-013**: Система ДОЛЖНА интегрироваться с Genius API (библиотека lyricsgenius) для получения текстов песен
- **FR-014**: Система ДОЛЖНА автоматически создавать резервные копии конфигурации и данных

#### P3 - Низкий приоритет (Long-term)

- **FR-015**: Система ДОЛЖНА интегрироваться с shazamio для распознавания музыки (бесплатная библиотека без API ключа)
- **FR-016**: Система ДОЛЖНА поддерживать минимум 4 языка интерфейса (ru, en, uk, es)
- **FR-017**: Система ДОЛЖНА автоматически определять язык браузера при первом визите
- **FR-018**: Система ДОЛЖНА предоставлять Grafana дашборды для визуализации метрик
- **FR-019**: Система ДОЛЖНА интегрироваться с Sentry для отслеживания ошибок
- **FR-020**: Система ДОЛЖНА поддерживать одновременное управление несколькими Telegram каналами с изолированными настройками

### Key Entities

- **PlaybackSettings**: Настройки воспроизведения пользователя (скорость, pitch, эквалайзер, channel_id)
- **RadioStream**: Информация о радио-потоке (URL, название, статус, метаданные)
- **ScheduledPlaylist**: Запланированный плейлист (время, плейлист, повторение, статус)
- **RateLimitCounter**: Счетчик запросов пользователя (user_id, count, window_start)
- **LyricsCache**: Кэш текстов песен (track_id, lyrics, synced_lyrics, source)
- **Localization**: Строки локализации (key, translations по языкам)
- **TelegramChannel**: Конфигурация Telegram канала (channel_id, name, settings, active)

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

#### Функциональность воспроизведения
- **SC-001**: Пользователь может изменить скорость воспроизведения за менее чем 1 секунду без прерывания звука
- **SC-002**: Seek-операция выполняется за менее чем 500ms для локальных файлов
- **SC-003**: Радио-поток начинает воспроизведение в течение 3 секунд после добавления

#### Безопасность и стабильность
- **SC-004**: Rate limiter блокирует 100% запросов, превышающих лимит
- **SC-005**: Система остается стабильной при 10 000 запросов/минуту от всех пользователей
- **SC-006**: Время восстановления после блокировки не превышает указанного в Retry-After

#### Пользовательский опыт
- **SC-007**: 95% пользователей успешно используют эквалайзер с первой попытки
- **SC-008**: Тексты песен загружаются для 80% популярных треков
- **SC-009**: Переключение языка интерфейса происходит мгновенно (менее 100ms)

#### Автоматизация
- **SC-010**: Запланированные плейлисты запускаются с точностью ±30 секунд от указанного времени
- **SC-011**: Резервное копирование выполняется ежедневно без вмешательства оператора

---

## Clarifications

### Session 2025-12-01

- Q: Какие GitHub репозитории использовать как источники кода? → A: YukkiMusicBot + telegram-bot-template (проверенные источники из Feature 016)
- Q: Какой алгоритм rate limiting использовать? → A: Fixed Window Counter (простой INCR + EXPIRE в Redis)
- Q: Какой API использовать для текстов песен (Lyrics)? → A: Genius API (lyricsgenius)
- Q: Какой сервис использовать для распознавания музыки? → A: shazamio (бесплатная библиотека, без API ключа)
- Q: Какую библиотеку i18n использовать для frontend? → A: react-i18next (стандарт индустрии, TypeScript support)

---

## Source Repositories (Источники кода)

### Основные репозитории

| Репозиторий | URL | Лицензия | Что берём |
|-------------|-----|----------|-----------|
| **YukkiMusicBot** | https://github.com/TeamYukki/YukkiMusicBot | MIT | Speed, Seek, Radio, Equalizer, Lyrics, Shazam |
| **telegram-bot-template** | https://github.com/Latand/telegram-bot-template | MIT | Rate limiting, Scheduler, i18n, Backup |

### Маппинг функций → файлов

| Функция (User Story) | Исходный файл | Целевая реализация |
|---------------------|---------------|-------------------|
| Speed/Pitch (US1) | `YukkiMusicBot/plugins/admins/speed.py` | `streamer/playback_control.py` |
| Seek/Rewind (US2) | `YukkiMusicBot/plugins/admins/seek.py` | `streamer/playback_control.py` |
| Radio streams (US3) | `YukkiMusicBot/plugins/play/radio.py` | `streamer/radio_handler.py` |
| Rate Limiting (US4) | `telegram-bot-template/bot/middlewares/throttling.py` | `backend/src/middleware/rate_limiter.py` |
| Priority Queues (US5) | Custom implementation based on existing queue | `backend/src/services/queue_service.py` |
| Equalizer (US6) | `YukkiMusicBot/plugins/admins/equalizer.py` | `streamer/audio_filters.py` |
| Scheduled Playlists (US7) | `telegram-bot-template/infrastructure/scheduler/` | `backend/src/services/scheduler_service.py` |
| Lyrics (US8) | `YukkiMusicBot/plugins/tools/lyrics.py` | `backend/src/services/lyrics_service.py` |
| Shazam (US9) | `YukkiMusicBot/plugins/tools/shazam.py` | `backend/src/services/shazam_service.py` |
| i18n (US10) | `telegram-bot-template/bot/locales/` | `frontend/src/i18n/`, `backend/locales/` |
| Multi-channel (US11) | Custom implementation | `streamer/multi_channel.py`, `backend/src/services/playback_service.py` |

---

## Assumptions

1. PyTgCalls и GStreamer поддерживают изменение скорости воспроизведения без значительных модификаций
2. Redis доступен для хранения счетчиков rate limiting и кэша
3. Внешние API для текстов песен (Genius, Musixmatch) имеют бесплатные тарифы для тестирования
4. ACRCloud или аналогичный сервис доступен для интеграции распознавания музыки
5. Frontend уже использует i18n-библиотеку (react-i18next) или может быть легко адаптирован
6. Код из YukkiMusicBot и telegram-bot-template совместим с текущей архитектурой проекта (проверено в Feature 016)

---

## Technical Decisions (Технические решения)

| Область | Решение | Обоснование |
|---------|---------|-------------|
| **Source Repos** | YukkiMusicBot + telegram-bot-template | Проверены в Feature 016, MIT лицензия |
| **Rate Limiting** | Fixed Window Counter (Redis INCR+EXPIRE) | Простота, производительность, достаточно для 100 req/min |
| **Lyrics API** | Genius API (lyricsgenius) | Большая база, готовая библиотека в YukkiMusicBot |
| **Music Recognition** | shazamio | Бесплатно, без API ключа, используется в YukkiMusicBot |
| **Frontend i18n** | react-i18next | Стандарт индустрии, TypeScript support, lazy loading |

---

## Out of Scope

- Собственный алгоритм распознавания музыки (используем внешний сервис)
- Поддержка оффлайн-режима для радио-потоков
- Редактирование аудиофайлов (обрезка, микширование)
- Социальные функции (комментарии к трекам, плейлисты от других пользователей)
- Монетизация (реклама, подписки)
