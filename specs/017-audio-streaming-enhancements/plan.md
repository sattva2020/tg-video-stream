# Implementation Plan: Улучшения аудио-стриминга

**Branch**: `017-audio-streaming-enhancements` | **Date**: 2025-01-20 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/017-audio-streaming-enhancements/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command based on spec.md and clarifications.

## Summary

Комплексные улучшения системы аудио-стриминга на основе рекомендаций P1-P3 из Feature 016 INTEGRATION_SUMMARY.md. 

**Основные направления:**
- **P1 (Quick Wins)**: Speed/Pitch control, Seek/Rewind, Radio streams, Rate limiting
- **P2 (Medium)**: Priority queues, Equalizer presets, Scheduled playlists, Lyrics display
- **P3 (Long-term)**: Shazam-like recognition, i18n localization

**Технический подход:** Адаптация проверенного кода из YukkiMusicBot и telegram-bot-template с интеграцией в существующую архитектуру (PyTgCalls + GStreamer для аудио, Redis для rate limiting/кэширования, react-i18next для фронтенда).

## Technical Context

**Language/Version**: Python 3.11+, TypeScript 5.x  
**Primary Dependencies**: FastAPI 0.104+, SQLAlchemy 2.0, PyTgCalls, GStreamer, React 18, react-i18next  
**Storage**: PostgreSQL 15 (основные данные), Redis 7 (rate limiting, кэш, очереди)  
**Testing**: pytest + fakeredis (backend), Vitest + Playwright (frontend)  
**Target Platform**: Linux server (Docker), Modern browsers (Chrome, Firefox, Safari)
**Project Type**: Web application (backend + frontend + streamer)  
**Performance Goals**: <500ms seek, <3s radio stream start, <100ms language switch, 10k req/min capacity  
**Constraints**: <200ms p95 для rate limiter, <1s для speed change, 99.5% uptime  
**Scale/Scope**: До 1000 concurrent users, 10 000 req/min aggregate

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| **Simplicity First** | ✅ PASS | Используем проверенные решения из YukkiMusicBot, а не custom implementations |
| **Existing Patterns** | ✅ PASS | Redis для rate limiting (уже используется), FastAPI middleware patterns |
| **Minimal Dependencies** | ✅ PASS | lyricsgenius, shazamio, react-i18next - все проверенные MIT библиотеки |
| **Progressive Enhancement** | ✅ PASS | P1→P2→P3 приоритизация, каждая фаза независимо deployable |
| **Single Responsibility** | ✅ PASS | Отдельные сервисы: rate_limiter, lyrics, shazam, scheduler |

**Gate Status**: ✅ ALL PASS - Ready for Phase 0

## Project Structure

### Documentation (this feature)

```text
specs/017-audio-streaming-enhancements/
├── plan.md              # This file (implementation plan)
├── research.md          # Phase 0 output (technology research)
├── data-model.md        # Phase 1 output (entity definitions)
├── quickstart.md        # Phase 1 output (quick implementation guide)
├── contracts/           # Phase 1 output (API contracts)
│   ├── playback-api.yaml
│   ├── radio-api.yaml
│   ├── rate-limiting.yaml
│   └── i18n-api.yaml
└── tasks.md             # Phase 2 output (/speckit.tasks command)
```

### Source Code (repository root)

```text
# Web application structure (backend + frontend + streamer)

backend/
├── src/
│   ├── models/
│   │   ├── playback_settings.py    # NEW: PlaybackSettings entity
│   │   ├── radio_stream.py         # NEW: RadioStream entity
│   │   ├── scheduled_playlist.py   # NEW: ScheduledPlaylist entity
│   │   └── lyrics_cache.py         # NEW: LyricsCache entity
│   ├── services/
│   │   ├── queue_service.py        # MODIFY: Add priority queues
│   │   ├── lyrics_service.py       # NEW: Genius API integration
│   │   ├── shazam_service.py       # NEW: shazamio integration
│   │   └── scheduler_service.py    # NEW: APScheduler integration
│   ├── middleware/
│   │   └── rate_limiter.py         # NEW: Redis rate limiting
│   └── api/
│       ├── playback.py             # NEW: Speed, seek endpoints
│       ├── radio.py                # NEW: Radio stream endpoints
│       └── lyrics.py               # NEW: Lyrics endpoints
└── tests/
    ├── unit/
    │   ├── test_rate_limiter.py
    │   └── test_queue_priority.py
    └── integration/
        └── test_playback_api.py

frontend/
├── src/
│   ├── components/
│   │   ├── SpeedControl.tsx        # NEW: Speed/pitch slider
│   │   ├── SeekBar.tsx             # MODIFY: Add seek buttons
│   │   ├── EqualizerPanel.tsx      # NEW: EQ presets
│   │   ├── LyricsDisplay.tsx       # NEW: Synced lyrics
│   │   └── LanguageSwitcher.tsx    # NEW: i18n selector
│   ├── i18n/
│   │   ├── index.ts                # NEW: react-i18next setup
│   │   └── locales/
│   │       ├── ru.json
│   │       ├── en.json
│   │       ├── uk.json
│   │       └── es.json
│   └── hooks/
│       └── usePlaybackSettings.ts  # NEW: Playback state hook
└── tests/
    └── components/
        └── SpeedControl.test.tsx

streamer/
├── playback_control.py             # NEW: Speed, seek, pitch
├── radio_handler.py                # NEW: HTTP stream support
└── audio_filters.py                # NEW: GStreamer EQ filters
```

**Structure Decision**: Web application with 3 main modules:
1. **backend/** - FastAPI API, business logic, external integrations
2. **frontend/** - React UI, i18n, user-facing components
3. **streamer/** - PyTgCalls + GStreamer audio processing

## Complexity Tracking

> **No violations detected. Constitution Check passed.**

| Aspect | Decision | Rationale |
|--------|----------|-----------|
| Rate Limiting Algorithm | Fixed Window Counter | Простейший алгоритм, достаточный для 100 req/min per user |
| External APIs | lyricsgenius + shazamio | Проверены в YukkiMusicBot, MIT лицензии |
| i18n Library | react-i18next | Индустриальный стандарт, TypeScript support |
| Audio Processing | GStreamer plugins | Уже используется в PyTgCalls |

---

## Implementation Phases

### Phase 0: Research & Discovery

**Status**: PENDING  
**Outputs**: `research.md`

| Research Task | Source | Priority |
|--------------|--------|----------|
| GStreamer speed/pitch plugins | YukkiMusicBot speed.py | P1 |
| Redis INCR+EXPIRE pattern | telegram-bot-template throttling.py | P1 |
| HTTP stream handling in PyTgCalls | YukkiMusicBot radio.py | P1 |
| lyricsgenius API usage | YukkiMusicBot lyrics.py | P2 |
| shazamio integration patterns | YukkiMusicBot shazam.py | P3 |
| react-i18next best practices | Official docs | P3 |

### Phase 1: Design & Contracts

**Status**: PENDING  
**Outputs**: `data-model.md`, `contracts/`, `quickstart.md`

| Design Task | Deliverable | Priority |
|-------------|-------------|----------|
| PlaybackSettings, RadioStream entities | data-model.md | P1 |
| RateLimitCounter Redis schema | data-model.md | P1 |
| Playback API endpoints | contracts/playback-api.yaml | P1 |
| Radio stream API | contracts/radio-api.yaml | P1 |
| Rate limiting headers | contracts/rate-limiting.yaml | P1 |
| Priority queue interface | data-model.md | P2 |
| Lyrics API contract | contracts/lyrics-api.yaml | P2 |
| i18n JSON structure | contracts/i18n-api.yaml | P3 |

### Phase 2: Implementation Tasks

**Status**: PENDING (requires /speckit.tasks)  
**Outputs**: `tasks.md`

| Epic | User Stories | Estimated Tasks |
|------|-------------|-----------------|
| **Playback Control (P1)** | US1, US2 | ~8 tasks |
| **Radio Streams (P1)** | US3 | ~5 tasks |
| **Rate Limiting (P1)** | US4 | ~6 tasks |
| **Priority Queues (P2)** | US5 | ~4 tasks |
| **Equalizer (P2)** | US6 | ~5 tasks |
| **Scheduled Playlists (P2)** | US7 | ~6 tasks |
| **Lyrics (P2)** | US8 | ~5 tasks |
| **Shazam (P3)** | US9 | ~4 tasks |
| **i18n (P3)** | US10 | ~8 tasks |

**Total estimated**: ~82 tasks

---

## Source Code References

| Feature | Source File | Target File |
|---------|------------|-------------|
| Speed/Pitch | `YukkiMusicBot/plugins/admins/speed.py` | `streamer/playback_control.py` |
| Seek/Rewind | `YukkiMusicBot/plugins/admins/seek.py` | `streamer/playback_control.py` |
| Radio streams | `YukkiMusicBot/plugins/play/radio.py` | `streamer/radio_handler.py` |
| Rate Limiting | `telegram-bot-template/bot/middlewares/throttling.py` | `backend/src/middleware/rate_limiter.py` |
| Equalizer | `YukkiMusicBot/plugins/admins/equalizer.py` | `streamer/audio_filters.py` |
| Scheduled Playlists | `telegram-bot-template/infrastructure/scheduler/` | `backend/src/services/scheduler_service.py` |
| Lyrics | `YukkiMusicBot/plugins/tools/lyrics.py` | `backend/src/services/lyrics_service.py` |
| Shazam | `YukkiMusicBot/plugins/tools/shazam.py` | `backend/src/services/shazam_service.py` |
| i18n | `telegram-bot-template/bot/locales/` | `frontend/src/i18n/` |

---

## Dependencies to Install

### Backend (Python)
```bash
pip install lyricsgenius shazamio apscheduler redis
```

### Frontend (npm)
```bash
npm install react-i18next i18next i18next-browser-languagedetector
```

---

## Next Steps

1. ✅ Run `/speckit.plan` (this file)
2. ⏳ Generate `research.md` with source code analysis
3. ⏳ Generate `data-model.md` with entity definitions
4. ⏳ Generate `contracts/` with OpenAPI specs
5. ⏳ Generate `quickstart.md` with implementation guide
6. ⏳ Run `/speckit.tasks` to generate `tasks.md`
7. ⏳ Run `/speckit.analyze` for validation
