# Feature Specification: User Approval

**Feature Branch**: `007-user-approval`
**Created**: 2025-11-22
**Status**: Draft
**Input**: User description: "любого нового пользователя Администратор должен утвердить, пока этого не произойдет пользователь нге сможет зайти на платформу"

> ⚖️ Конституция: все текстовые блоки заполняем на русском. Каждая пользовательская история
> должна быть независимой, иметь измеримые критерии успеха и ссылаться на будущие тесты и
> документацию, иначе `/speckit.plan` не пройдет гейт.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Регистрация и ожидание утверждения (Priority: P1)

Как новый пользователь, я хочу зарегистрироваться и получить уведомление о необходимости утверждения моей учетной записи, чтобы я понимал, почему не могу войти сразу.

**Why this priority**: Критически важно для безопасности платформы и выполнения основного требования.

**Independent Test**: Можно протестировать процесс регистрации и попытку входа без участия администратора.

**Acceptance Scenarios**:

1. **Given** я нахожусь на странице регистрации, **When** я успешно заполняю форму и отправляю данные, **Then** я вижу сообщение о том, что аккаунт создан и ожидает подтверждения администратором.
2. **Given** я зарегистрировался, но еще не утвержден, **When** я пытаюсь войти в систему, **Then** я вижу ошибку "Аккаунт ожидает подтверждения" и не получаю доступ.
3. **Given** существует уже учётная запись с тем же email в статусе "Ожидает подтверждения", **When** кто-то пытается зарегистрировать новый аккаунт с тем же email, **Then** система возвращает сообщение "Аккаунт уже существует и ожидает утверждения" и не создаёт дубликат.

---

### User Story 2 - Утверждение пользователя администратором (Priority: P1)

Как администратор, я хочу видеть список пользователей, ожидающих подтверждения, и иметь возможность утвердить их, чтобы предоставить им доступ к платформе.

**Why this priority**: Необходимо для того, чтобы новые пользователи могли начать пользоваться системой.

**Independent Test**: Можно протестировать, создав тестового пользователя (через БД или API) и утвердив его через интерфейс администратора.

**Acceptance Scenarios**:

1. **Given** я вошел как администратор и есть новые пользователи, **When** я открываю список пользователей, **Then** я вижу пользователей со статусом "Ожидает подтверждения".
2. **Given** я вижу пользователя в статусе "Ожидает подтверждения", **When** я нажимаю "Утвердить", **Then** статус пользователя меняется на "Утвержден", и он исчезает из списка ожидающих (или меняет статус визуально).

---

### User Story 3 - Отклонение пользователя администратором (Priority: P2)

Как администратор, я хочу иметь возможность отклонить регистрацию нового пользователя, чтобы предотвратить доступ нежелательных лиц.

**Why this priority**: Важно для модерации и безопасности.

**Independent Test**: Тестируется аналогично утверждению, но с действием отклонения.

**Acceptance Scenarios**:

1. **Given** я вижу пользователя в статусе "Ожидает подтверждения", **When** я нажимаю "Отклонить", **Then** статус пользователя меняется на "Отклонен" (или пользователь удаляется), и он не может войти в систему.

### Edge Cases

- Что происходит, если администратор сам регистрируется? (Предполагаем, что первый админ создается скриптом, а последующие проходят тот же процесс или создаются другим админом).
- Что если пользователь пытается зарегистрироваться повторно с тем же email, пока он в статусе "Ожидает"? (Система должна сообщать, что аккаунт уже существует).

### Assumptions

- Администратор уже существует в системе (создан ранее или через скрипт).
- Уведомления (email/telegram) не входят в MVP, пользователь узнает о статусе через интерфейс входа.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА присваивать статус "ожидает подтверждения" (pending) всем новым пользователям при регистрации.
- **FR-002**: Система ДОЛЖНА запрещать вход (аутентификацию) пользователям со статусом "ожидает подтверждения".
- **FR-003**: Система ДОЛЖНА предоставлять Администратору интерфейс для просмотра списка пользователей, ожидающих подтверждения.
- **FR-004**: Система ДОЛЖНА позволять Администратору менять статус пользователя с "ожидает подтверждения" на "утвержден" (approved).
- **FR-005**: Система ДОЛЖНА позволять Администратору менять статус пользователя с "ожидает подтверждения" на "отклонен" (rejected) или удалять его.
- **FR-006**: Система ДОЛЖНА разрешать вход пользователям со статусом "утвержден".
- **FR-007**: Если при попытке регистрации найден существующий пользователь с тем же email в статусе "ожидает подтверждения", система ДОЛЖНА отказать в регистрации и вернуть информативное сообщение об уже существующем аккаунте, не создавая дубликат.

### Key Entities *(include if feature involves data)*

- **User**: Должен иметь атрибут состояния (Status), который может принимать значения: Pending, Approved, Rejected.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 100% новых регистраций через публичный интерфейс попадают в статус "ожидает подтверждения".
- **SC-002**: Пользователь со статусом "ожидает подтверждения" не может получить доступ к защищенным ресурсам API.
- **SC-003**: Администратор может найти и утвердить нового пользователя менее чем за 1 минуту.
- **SC-004**: Утвержденный пользователь успешно входит в систему с первой попытки после смены статуса.

## Clarifications

### Session 2025-11-22

- Q: Как администратор должен получать уведомления о новой регистрации — Email, In‑app, Telegram, Webhook? → A/C: Email и Telegram (администраторам должно приходить уведомление при регистрации нового пользователя).
- Q: Как отправлять уведомления — синхронно или безопасно фоновой задачей (queue)? → Recommended: Async background job (queue) — регистрация должна оставаться быстрой; уведомления отправляются через очередь с повторными попытками и наблюдаемостью.
- Q: Что делать если тот же email пытается зарегистрироваться повторно, пока предыдущая учётная запись в статусе "Ожидает"? → A: Блокировать новую регистрацию и вернуть информативный ответ "Аккаунт уже существует и ожидает утверждения"; не создавать дубликаты.
