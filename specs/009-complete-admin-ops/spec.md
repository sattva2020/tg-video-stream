# Feature Specification: Complete Admin Ops

**Feature Branch**: `009-complete-admin-ops`  
**Created**: 2024-05-22  
**Status**: Draft  
**Input**: User description: "1. Управление трансляцией (перезапуск, логи). 2. UI для логов и метрик. 3. Авто-перезапуск сессий. 4. Аргументы FFmpeg. 5. Управление плейлистом."

> ⚖️ Конституция: все текстовые блоки заполняем на русском. Каждая пользовательская история
> должна быть независимой, иметь измеримые критерии успеха и ссылаться на будущие тесты и
> документацию, иначе `/speckit.plan` не пройдет гейт.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Управление трансляцией и мониторинг (Priority: P1)

Как администратор, я хочу иметь возможность перезапускать стрим и видеть его текущее состояние (логи, метрики), чтобы оперативно реагировать на проблемы.

**Why this priority**: Это критический функционал для поддержания работоспособности стрима. Без этого администратор слеп и не может управлять процессом.

**Independent Test**: Можно протестировать API и UI перезапуска и просмотра логов независимо от других функций.

**Acceptance Scenarios**:

1. **Given** Стрим запущен, **When** Администратор нажимает кнопку "Перезапуск" в UI, **Then** Сервис стримера перезапускается, и в логах появляется сообщение о старте.
2. **Given** Стрим работает, **When** Администратор открывает страницу "Логи", **Then** Отображаются последние логи сервиса стримера в реальном времени (или с обновлением).
3. **Given** Стрим работает, **When** Администратор открывает страницу "Метрики", **Then** Отображаются текущие показатели CPU и RAM контейнера/сервиса.

---

### User Story 2 - Управление плейлистом (Priority: P2)

Как администратор, я хочу управлять списком воспроизведения (добавлять, удалять, менять порядок), чтобы изменять контент трансляции без доступа к файловой системе сервера.

**Why this priority**: Важно для управления контентом, но стрим может работать и со статичным плейлистом.

**Independent Test**: Можно протестировать API и UI управления плейлистом.

**Acceptance Scenarios**:

1. **Given** Плейлист существует, **When** Администратор добавляет новую ссылку через UI, **Then** Ссылка появляется в списке и сохраняется в конфигурации.
2. **Given** В плейлисте есть элементы, **When** Администратор меняет их порядок и сохраняет, **Then** Порядок воспроизведения изменяется соответственно.
3. **Given** В плейлисте есть элемент, **When** Администратор удаляет его, **Then** Элемент удаляется из конфигурации.

---

### User Story 3 - Автоматическое восстановление сессии (Priority: P2)

Как владелец системы, я хочу, чтобы сессия Telegram автоматически пересоздавалась при истечении/ошибке, чтобы стрим не прерывался надолго.

**Why this priority**: Обеспечивает автономность системы.

**Independent Test**: Можно симулировать "протухание" сессии и проверить запуск восстановления.

**Acceptance Scenarios**:

1. **Given** Сессия невалидна (файл удален или ошибка авторизации), **When** Стример запускается или обнаруживает ошибку, **Then** Запускается механизм регенерации сессии, и создается новая валидная сессия.

---

### User Story 4 - Расширенная конфигурация (Priority: P3)

Как инженер, я хочу иметь возможность передавать дополнительные аргументы в движок обработки медиа через переменные окружения, чтобы тонко настраивать параметры кодирования без изменения кода.

**Why this priority**: Удобство настройки, не блокирует основной функционал.

**Independent Test**: Запуск с переменной конфигурации и проверка процесса.

**Acceptance Scenarios**:

1. **Given** Переменная окружения с аргументами установлена (например, `FFMPEG_ARGS`), **When** Стример запускает процесс обработки, **Then** Эти аргументы применяются к процессу.

### Edge Cases

- Что происходит, если плейлист пуст? (Стример должен корректно обрабатывать или ждать).
- Что происходит, если перезапуск стрима не удался (завис)? (UI должен сообщать об ошибке).
- Что если логи слишком большие? (Нужна пагинация или ротация, или показ только последних N строк).

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Backend API ДОЛЖЕН предоставлять эндпоинт `POST /admin/restart_stream`, который инициирует перезапуск сервиса стримера (используя системный менеджер процессов).
- **FR-002**: Backend API ДОЛЖЕН предоставлять эндпоинт `GET /admin/logs`, возвращающий последние N строк логов сервиса стримера.
- **FR-003**: Backend API ДОЛЖЕН предоставлять эндпоинт `GET /admin/metrics`, возвращающий текущее использование ресурсов (CPU, RAM) процессом стримера.
- **FR-004**: Backend API ДОЛЖЕН предоставлять CRUD эндпоинты для управления конфигурацией плейлиста (Get, Update).
- **FR-005**: Frontend (Admin UI) ДОЛЖЕН иметь страницу "Dashboard" с кнопками управления (Start/Stop/Restart) и отображением статуса.
- **FR-006**: Frontend (Admin UI) ДОЛЖЕН иметь компонент для отображения логов.
- **FR-007**: Frontend (Admin UI) ДОЛЖЕН иметь страницу управления плейлистом (список, добавление, удаление, сортировка).
- **FR-008**: Стример ДОЛЖЕН считывать конфигурацию дополнительных аргументов кодирования (например, через переменную окружения `FFMPEG_ARGS`) и применять их к процессу обработки медиа.
- **FR-009**: Система ДОЛЖНА включать механизм автоматического восстановления сессии, который вызывается при ошибке авторизации.

### Key Entities *(include if feature involves data)*

- **Playlist**: Список медиа-ресурсов для воспроизведения.
- **StreamStatus**: Объект состояния стрима (Running, Stopped, Error, Uptime).
- **SystemMetrics**: Объект с данными о нагрузке (CPU %, RAM usage).

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Администратор может перезапустить стрим через UI менее чем за 3 клика, и процесс перезапуска занимает не более 15 секунд.
- **SC-002**: Логи отображаются в UI с задержкой не более 5 секунд.
- **SC-003**: Изменения в плейлисте применяются (сохраняются в файл) мгновенно и подхватываются стримером при следующем чтении (или перезапуске).
- **SC-004**: При установке `FFMPEG_ARGS` процесс ffmpeg запускается с указанными параметрами (проверяется через `ps` или логи).
