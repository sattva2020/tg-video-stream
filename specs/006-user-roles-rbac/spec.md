# Feature Specification: User Roles (RBAC)

**Feature Branch**: `006-user-roles-rbac`
**Created**: 2025-11-22
**Status**: Draft
**Input**: User description: "Implement user roles (RBAC) - admin and user roles, database migration, backend auth update, frontend protection."

> ⚖️ Конституция: все текстовые блоки заполняем на русском. Каждая пользовательская история
> должна быть независимой, иметь измеримые критерии успеха и ссылаться на будущие тесты и
> документацию, иначе `/speckit.plan` не пройдет гейт.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Admin Access Control (Priority: P1)

Как администратор, я хочу иметь доступ к панели управления и критическим функциям (перезапуск стрима), чтобы управлять сервисом. Обычные пользователи не должны иметь доступа к этим функциям.

**Why this priority**: Это основа безопасности и управления сервисом. Без этого любой пользователь может нарушить работу стрима.

**Independent Test**: Можно протестировать, создав пользователя с ролью `admin` и пользователя с ролью `user`, и проверив доступ к защищенным разделам.

**Acceptance Scenarios**:

1. **Given** я авторизован как `admin`, **When** я запрашиваю доступ к защищенному разделу (например, Панель Администратора), **Then** я получаю доступ и вижу интерфейс администратора.
2. **Given** я авторизован как `user`, **When** я пытаюсь открыть защищенный раздел по прямой ссылке, **Then** я перенаправлен на главную или вижу сообщение "Доступ запрещен".
3. **Given** я авторизован как `user`, **When** я пытаюсь выполнить действие администратора, **Then** система отклоняет запрос с ошибкой доступа.

---

### User Story 2 - Default User Role (Priority: P1)

Как новый пользователь, я хочу автоматически получать роль `user` при регистрации, чтобы иметь базовый доступ к просмотру контента, но не к управлению.

**Why this priority**: Обеспечивает безопасность по умолчанию для всех новых регистраций.

**Independent Test**: Регистрация нового пользователя и проверка его роли в системе.

**Acceptance Scenarios**:

1. **Given** я новый посетитель, **When** я регистрируюсь через форму регистрации, **Then** моя учетная запись создается с ролью `user`.
2. **Given** я новый пользователь, **When** я вхожу в систему, **Then** в моих данных сессии присутствует роль `user`.

---

### User Story 3 - UI Adaptation (Priority: P2)

Как пользователь, я хочу видеть только те элементы интерфейса, которые мне доступны, чтобы не путаться в недоступных функциях.

**Why this priority**: Улучшает UX и предотвращает попытки использования недоступных функций.

**Independent Test**: Визуальная проверка интерфейса под разными ролями.

**Acceptance Scenarios**:

1. **Given** я авторизован как `user`, **When** я нахожусь на главной странице, **Then** я НЕ вижу кнопок управления стримом ("Перезапустить", "Стоп").
2. **Given** я авторизован как `admin`, **When** я нахожусь на главной странице, **Then** я вижу кнопки управления стримом.

### Edge Cases

- **Попытка прямого доступа**: Если пользователь вручную вводит URL админской панели, система должна перенаправить его на главную страницу или показать ошибку доступа.
- **Смена роли на лету**: Если роль пользователя изменена администратором, изменения должны вступить в силу при следующем входе или обновлении токена (в зависимости от реализации сессии).

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА хранить роль пользователя в учетной записи.
- **FR-002**: Система ДОЛЖНА поддерживать как минимум две роли: `user` и `admin`.
- **FR-003**: При регистрации нового пользователя ему ДОЛЖНА автоматически присваиваться роль `user`.
- **FR-004**: Токен доступа или сессия ДОЛЖНЫ содержать информацию о текущей роли пользователя.
- **FR-005**: Система ДОЛЖНА блокировать доступ к функциям администратора для пользователей без роли `admin`.
- **FR-006**: Интерфейс ДОЛЖЕН скрывать элементы управления, требующие прав администратора, если у пользователя нет роли `admin`.
- **FR-007**: Интерфейс ДОЛЖЕН предотвращать навигацию на страницы администратора для пользователей без роли `admin`.

### Key Entities *(include if feature involves data)*

- **User**: Расширяется полем `role` (Тип: Роль пользователя).

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 100% попыток доступа обычного пользователя к функциям администратора блокируются системой.
- **SC-002**: Новые пользователи регистрируются с ролью `user` в 100% случаев.
- **SC-003**: Администратор имеет доступ ко всем функциям управления стримом.
