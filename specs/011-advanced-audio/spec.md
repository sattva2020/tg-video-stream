# Feature Specification: Advanced Audio & Playlist UI

**Feature Branch**: `011-advanced-audio`
**Created**: 2024-05-23
**Status**: Draft
**Input**: User description: "Implement advanced audio features including transcoding for unsupported formats (FLAC, OGG) and UI integration for playlist management."

> ⚖️ Конституция: все текстовые блоки заполняем на русском. Каждая пользовательская история
> должна быть независимой, иметь измеримые критерии успеха и ссылаться на будущие тесты и
> документацию, иначе `/speckit.plan` не пройдет гейт.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Transcoding Unsupported Formats (Priority: P1)

Как пользователь, я хочу иметь возможность воспроизводить аудиофайлы в форматах FLAC, OGG и других, которые не поддерживаются нативно, чтобы мне не приходилось конвертировать их вручную.

**Why this priority**: Это основная функциональность "Advanced Audio", расширяющая возможности стримера и делающая его универсальным.

**Independent Test**: Можно протестировать, добавив ссылку на FLAC файл в плейлист и проверив, что звук идет в голосовом чате.

**Acceptance Scenarios**:

1. **Given** стример запущен, **When** я добавляю URL на FLAC файл, **Then** стример автоматически транскодирует его и воспроизводит звук без искажений.
2. **Given** стример запущен, **When** я добавляю URL на OGG файл (не Opus), **Then** стример транскодирует его и воспроизводит.
3. **Given** стример запущен, **When** я добавляю URL на файл с неизвестным кодеком, **Then** система пытается его транскодировать, а при неудаче корректно пропускает трек.

---

### User Story 2 - Playlist Management UI (Priority: P2)

Как пользователь, я хочу видеть текущий плейлист в веб-интерфейсе и управлять им (добавлять, удалять треки), чтобы контролировать эфир без доступа к консоли сервера.

**Why this priority**: Обеспечивает удобство использования (UX) и визуальный контроль, превращая скрипт в полноценный продукт.

**Independent Test**: Можно открыть веб-страницу, добавить трек и увидеть его в списке.

**Acceptance Scenarios**:

1. **Given** открыт веб-интерфейс, **When** я ввожу URL и нажимаю "Добавить", **Then** трек появляется в списке воспроизведения на экране и в очереди сервера.
2. **Given** в плейлисте есть треки, **When** я нажимаю "Удалить" на треке, **Then** он исчезает из списка и не воспроизводится.
3. **Given** играет трек, **When** я открываю UI, **Then** я вижу текущий играющий трек выделенным.

### Edge Cases

- **Поврежденный файл**: Если файл не удается декодировать, система должна пропустить его и перейти к следующему треку в очереди, записав ошибку в лог.
- **Неподдерживаемый формат**: Если формат не поддерживается транскодером, система должна уведомить пользователя (если через UI) или пропустить трек.
- **Сетевые ошибки**: При разрыве соединения во время стриминга система должна попытаться переподключиться или перейти к следующему треку.
- **Пустой плейлист**: При попытке удалить последний трек система должна корректно обработать пустое состояние (остановить воспроизведение или играть тишину).

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА автоматически определять формат аудиофайла по URL или заголовкам (Content-Type) перед воспроизведением.
- **FR-002**: Система ДОЛЖНА использовать механизм транскодирования для преобразования форматов (FLAC, OGG, WAV, WMA) в формат, совместимый с модулем воспроизведения, в реальном времени.
- **FR-003**: Backend ДОЛЖЕН предоставлять программный интерфейс для получения текущего состояния плейлиста (список треков, текущий трек).
- **FR-004**: Backend ДОЛЖЕН предоставлять программный интерфейс для добавления и удаления элементов плейлиста.
- **FR-005**: Frontend ДОЛЖЕН отображать список треков с их названиями (если доступны) и статусом (играет/в очереди).
- **FR-006**: Frontend ДОЛЖЕН иметь форму для добавления новых ссылок в плейлист с валидацией URL.

### Key Entities *(include if feature involves data)*

- **PlaylistItem**: Объект, содержащий URL, тип (audio/video), метаданные (название, длительность), статус (playing, queued, error) и ID.
- **TranscodingProfile**: Набор параметров конвертации для различных входных форматов.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Файлы формата FLAC/OGG воспроизводятся с задержкой старта не более 5 секунд (время на буферизацию/старт транскодирования).
- **SC-002**: Пользователь может добавить трек через UI, и он отобразится в списке менее чем за 1 секунду.
- **SC-003**: Стример успешно обрабатывает очередь из смешанных форматов (MP3 -> FLAC -> MP3) без прерывания вещания.
- **SC-004**: UI корректно отображает состояние плейлиста даже при обновлении страницы (синхронизация с сервером).
