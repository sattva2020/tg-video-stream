# Правило синхронизации локального и удалённого репозиториев

## ⚠️ КРИТИЧЕСКИ ВАЖНОЕ ПРАВИЛО ДЛЯ AI-АГЕНТОВ

### Принцип: LOCAL-FIRST (Локальный репозиторий первичен)

**ВСЕ изменения ОБЯЗАТЕЛЬНО должны сначала вноситься в локальный репозиторий, а затем деплоиться на удалённый сервер.**

---

## Обязательный порядок действий

### 1. Изменения в коде
```
1. Редактировать файл ЛОКАЛЬНО
2. git add + git commit + git push
3. SSH на сервер: git pull + build/restart
```

### 2. Изменения в конфигурации (.env, config файлы)
```
1. Редактировать файл ЛОКАЛЬНО (корневой .env, frontend/.env, backend/.env)
2. SSH на сервер: обновить соответствующий .env файл
3. Если нужен rebuild: git pull + npm run build
4. Если нужен restart: systemctl restart service
```

### 3. Изменения только на сервере (emergency fix)
```
1. Сделать изменение на сервере
2. НЕМЕДЛЕННО внести то же изменение в локальный репозиторий
3. Задокументировать в коммите: "sync: emergency fix from server"
```

---

## Чек-лист перед завершением задачи

- [ ] Все изменения кода есть в локальном репозитории?
- [ ] Все .env переменные добавлены локально?
  - [ ] Корневой `.env`
  - [ ] `frontend/.env` (VITE_* переменные)
  - [ ] `backend/.env` (если используется)
- [ ] Изменения закоммичены и запушены?
- [ ] Сервер обновлён через git pull?

---

## Типичные ошибки (НЕ ДОПУСКАТЬ!)

❌ Добавить переменную только в .env на сервере
❌ Создать файл только на сервере через SSH
❌ Изменить конфиг на сервере без синхронизации
❌ Забыть про frontend/.env при добавлении VITE_* переменных

---

## Структура .env файлов

| Файл | Назначение | Где используется |
|------|------------|------------------|
| `.env` | Основные переменные проекта | Docker, backend, общие |
| `frontend/.env` | Vite переменные (VITE_*) | Frontend build |
| `backend/.env` | Backend-специфичные | Python/FastAPI |

### Правило для VITE переменных:
Если добавляется `VITE_*` переменная:
1. Добавить в `frontend/.env` локально
2. Добавить в `/opt/sattva-streamer/frontend/.env` на сервере
3. Выполнить `npm run build` на сервере

---

## Пример правильного workflow

### Добавление TELEGRAM_BOT_ID:

```bash
# 1. ЛОКАЛЬНО: редактируем .env
echo "TELEGRAM_BOT_ID=8431060192" >> .env

# 2. ЛОКАЛЬНО: редактируем frontend/.env
echo "VITE_TELEGRAM_BOT_ID=8431060192" >> frontend/.env

# 3. Коммитим (если .env не в .gitignore)
# или документируем в README/docs

# 4. НА СЕРВЕРЕ: добавляем в .env
ssh user@server "echo 'TELEGRAM_BOT_ID=8431060192' >> /opt/app/.env"
ssh user@server "echo 'VITE_TELEGRAM_BOT_ID=8431060192' >> /opt/app/frontend/.env"

# 5. НА СЕРВЕРЕ: rebuild если нужно
ssh user@server "cd /opt/app/frontend && npm run build"
```

---

## Дата создания правила
**30 ноября 2025**

## Причина создания
AI-агент добавил `VITE_TELEGRAM_BOT_ID` только на удалённый сервер, не обновив локальный репозиторий. Это привело к рассинхронизации и потенциальным проблемам при будущих деплоях.

---

**Это правило ОБЯЗАТЕЛЬНО для выполнения при КАЖДОМ изменении!**
