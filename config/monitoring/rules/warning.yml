# Warning Alert Rules for 24/7 TV Telegram
# These alerts indicate potential issues that should be investigated

groups:
  - name: warnings
    rules:
      # High latency on API
      - alert: HighLatency
        expr: |
          histogram_quantile(0.95, 
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le, path)
          ) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High API latency on {{ $labels.path }}"
          description: "95th percentile latency is above 1 second for {{ $labels.path }}."

      # Buffer underruns
      - alert: BufferUnderruns
        expr: rate(buffer_underruns_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Buffer underruns detected"
          description: "More than 0.1 buffer underruns per second. Stream quality may be affected."

      # Connection pool exhaustion warning
      - alert: ConnectionPoolLow
        expr: |
          db_connections_idle{pool="default"} < 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Database connection pool running low"
          description: "Less than 2 idle connections available. Consider increasing pool size."

      # Multiple reconnection attempts
      - alert: FrequentReconnects
        expr: rate(reconnect_attempts_total[15m]) > 0.2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Frequent reconnection attempts"
          description: "More than 3 reconnection attempts in 15 minutes. Network or Telegram API issues."

      # Elevated error rate (5-10%)
      - alert: ElevatedErrorRate
        expr: |
          sum(rate(http_requests_total{status=~"5.."}[5m])) 
          / sum(rate(http_requests_total[5m])) > 0.05
          and
          sum(rate(http_requests_total{status=~"5.."}[5m])) 
          / sum(rate(http_requests_total[5m])) <= 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Elevated error rate"
          description: "5-10% of HTTP requests are failing. Investigate before it becomes critical."

      # Disk space warning
      - alert: DiskSpaceWarning
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} 
          / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 20
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Disk space running low"
          description: "Less than 20% disk space remaining on root filesystem."

      # High memory usage
      - alert: HighMemoryUsage
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "More than 85% of memory is in use for 10 minutes."

      # Container restart loop
      - alert: ContainerRestarting
        expr: |
          increase(kube_pod_container_status_restarts_total[1h]) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Container restarting frequently"
          description: "Container {{ $labels.container }} has restarted more than 3 times in the last hour."

      # Slow database queries
      - alert: SlowDatabaseQueries
        expr: |
          histogram_quantile(0.95, 
            sum(rate(db_query_duration_seconds_bucket[5m])) by (le, query_type)
          ) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Slow database queries"
          description: "95th percentile of {{ $labels.query_type }} queries exceeds 500ms."

      # Redis connection issues
      - alert: RedisConnectionIssues
        expr: redis_connected_clients < 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Redis connection issues"
          description: "No connected Redis clients detected."
