# Архитектура аутентификации

**Версия документа**: 1.0  
**Дата создания**: 4 декабря 2025  
**Статус**: Актуален

## Обзор

Проект использует **OAuth-based аутентификацию** через внешние провайдеры. 
Вход через email/password **отключён** для конечных пользователей.

## Поддерживаемые методы входа

### Продакшен (для пользователей)

| Метод | Статус | Описание |
|-------|--------|----------|
| **Google OAuth** | ✅ Активен | Основной метод входа |
| **Telegram Login Widget** | ✅ Активен | Вход через Telegram-бота |
| Email/Password | ❌ Отключён | Не используется |

### Разработка/Тестирование

| Метод | Статус | Когда использовать |
|-------|--------|-------------------|
| Email/Password | 🧪 Опционально | Только для QA/Playwright тестов |

## Конфигурация

### Переменные окружения (Frontend)

```env
# ВАЖНО: Вход через email/password ОТКЛЮЧЁН по умолчанию
# Включать ТОЛЬКО для автотестов (Playwright, E2E)
VITE_ENABLE_BASIC_LOGIN=false
```

### Где настраивается

- **Development**: `frontend/.env`
- **Production**: `frontend/.env.production`
- **Тесты**: Можно временно включить для Playwright

## ⚠️ ВАЖНЫЕ ПРАВИЛА

### 1. Email/Password вход НЕ для пользователей

**НИКОГДА** не включайте `VITE_ENABLE_BASIC_LOGIN=true` в production!

Этот метод:
- Только для автоматизированных тестов (Playwright, Cypress)
- Не имеет двухфакторной аутентификации
- Упрощённый для тестовых сценариев

### 2. Google OAuth — основной метод

Все реальные пользователи должны входить через:
- Google OAuth (первичный)
- Telegram Login Widget (альтернативный)

### 3. При появлении формы email/password в UI

Если форма email/password видна на странице входа:

1. Проверь `VITE_ENABLE_BASIC_LOGIN` в `.env`
2. Должно быть `VITE_ENABLE_BASIC_LOGIN=false`
3. Перезапусти dev-сервер: `npm run dev`

## Архитектура компонентов

```
┌─────────────────────────────────────────────────────────────┐
│                     AuthPage3D.tsx                           │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                    AuthCard.tsx                      │   │
│   │                                                      │   │
│   │  ┌─────────────────────────────────────────────┐    │   │
│   │  │  Email/Password Form (условный рендер)      │    │   │
│   │  │  Показывается только если:                   │    │   │
│   │  │  VITE_ENABLE_BASIC_LOGIN === 'true'         │    │   │
│   │  └─────────────────────────────────────────────┘    │   │
│   │                                                      │   │
│   │  ┌─────────────────────────────────────────────┐    │   │
│   │  │  GoogleLoginButton (всегда показывается)    │    │   │
│   │  └─────────────────────────────────────────────┘    │   │
│   │                                                      │   │
│   │  ┌─────────────────────────────────────────────┐    │   │
│   │  │  TelegramLogin (всегда показывается)        │    │   │
│   │  └─────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## Код условного рендера

В `AuthCard.tsx`:

```tsx
const enableBasicLogin = (import.meta.env.VITE_ENABLE_BASIC_LOGIN ?? 'true') !== 'false';

// ...

{enableBasicLogin && (
  <form className="..." onSubmit={handleBasicLogin}>
    {/* Email/Password поля */}
  </form>
)}
```

## Чек-лист для деплоя

- [ ] `VITE_ENABLE_BASIC_LOGIN=false` в `.env.production`
- [ ] `VITE_ENABLE_BASIC_LOGIN=false` в `.env` (dev)
- [ ] Google OAuth настроен (GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET)
- [ ] Telegram Bot настроен (VITE_TELEGRAM_BOT_USERNAME)

## История изменений

| Дата | Изменение |
|------|-----------|
| 04.12.2025 | Создан документ. Email/password отключён в dev |
