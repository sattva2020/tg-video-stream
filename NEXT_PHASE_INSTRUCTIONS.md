# Next Steps: Phase 6 - Database Migrations

**Current Status**: Phase 5 (Telegram Commands) ✅ Complete at 38/82 tasks (46%)

---

## Phase 6 Overview: Database Migrations

**Goal**: Create Alembic migrations for 4 new SQLAlchemy models created in Phase 3

**Why Important**: 
- Required before any deployment to production
- Enables database schema versioning and rollback capability
- Allows team members to sync database schema via `alembic upgrade head`

**Time Estimate**: 30-45 minutes

---

## Tasks to Complete

### T012: PlaybackSettings Migration
- **Model**: `backend/src/models/playback_settings.py`
- **Table**: `playback_settings`
- **Fields**:
  - `id` (Integer, Primary Key)
  - `user_id` (Integer, Foreign Key → users.id, Unique)
  - `speed` (Float, default 1.0, constraint: 0.5-2.0)
  - `pitch_correction` (Boolean, default True)
  - `equalizer_preset` (String(50), default "flat")
  - `equalizer_custom` (JSON, nullable)
  - `language` (String(5), default "ru", constraint: ru|en|uk|es)
  - `show_lyrics` (Boolean, default True)

### T028: RadioStream Migration
- **Model**: `backend/src/models/radio_stream.py`
- **Table**: `radio_streams`
- **Fields**:
  - `id` (Integer, Primary Key)
  - `url` (String(500), unique, not null)
  - `name` (String(100), not null)
  - `genre` (String(50), nullable)
  - `country` (String(50), nullable)
  - `added_by` (Integer, Foreign Key → users.id)
  - `active` (Boolean, default True)
  - `created_at` (DateTime, default now())
  - `updated_at` (DateTime, default now())

### T047: ScheduledPlaylist Migration
- **Model**: `backend/src/models/scheduled_playlist.py`
- **Table**: `scheduled_playlists`
- **Fields**:
  - `id` (Integer, Primary Key)
  - `playlist_id` (Integer, Foreign Key → playlists.id)
  - `time` (String(50), not null) — HH:MM or cron expression
  - `recurrence` (String(20), default "daily")
  - `timezone` (String(50), default "UTC")
  - `enabled` (Boolean, default True)
  - `created_by` (Integer, Foreign Key → users.id)
  - `created_at` (DateTime, default now())
  - `updated_at` (DateTime, default now())

### T054: LyricsCache Migration
- **Model**: `backend/src/models/lyrics_cache.py`
- **Table**: `lyrics_cache`
- **Fields**:
  - `id` (Integer, Primary Key)
  - `track_id` (String(100), unique, not null)
  - `artist` (String(200), not null)
  - `title` (String(200), not null)
  - `lyrics` (Text, not null)
  - `cached_at` (DateTime, default now())
  - `expires_at` (DateTime, indexed)
  - `ttl_days` (Integer, default 7)

---

## Implementation Steps

### Step 1: Generate Migrations

```bash
# Navigate to backend directory
cd /e/My/Sattva/telegram/backend

# Generate autogenerated migrations from models
alembic revision --autogenerate -m "Add audio streaming tables"

# This will create a new file in alembic/versions/ like:
# 001_add_audio_streaming_tables.py (exact filename depends on latest version)
```

### Step 2: Verify Migration Files

Each of the 4 models should have corresponding migration steps in the generated file:
- CreateTable for playback_settings
- CreateTable for radio_streams
- CreateTable for scheduled_playlists
- CreateTable for lyrics_cache

### Step 3: Test Migration

```bash
# Test upgrade
alembic upgrade head

# Verify tables created
psql -U postgres -d your_database -c "\dt"

# Test rollback (optional, for confidence)
alembic downgrade -1
alembic upgrade head
```

### Step 4: Mark Tasks Complete

After migrations are tested and working:
- [ ] T012 - Mark as [x]
- [ ] T028 - Mark as [x]
- [ ] T047 - Mark as [x]
- [ ] T054 - Mark as [x]

Update in: `specs/017-audio-streaming-enhancements/tasks.md`

---

## Quick Command Reference

```bash
# From backend/ directory:

# Create migration from models
alembic revision --autogenerate -m "Add audio streaming tables"

# Apply latest migration
alembic upgrade head

# Rollback one version
alembic downgrade -1

# View current migration version
alembic current

# View migration history
alembic history

# Show pending upgrades
alembic upgrade --sql head
```

---

## Estimated Progress After Phase 6

| Phase | Status | Tasks | % |
|-------|--------|-------|---|
| P1-P5 | ✅ Complete | 38/38 | 100% |
| P6 | ⏳ In Progress | 4/4 | 100% (after completion) |
| **Overall** | | **42/82** | **51%** |

---

## Key Points

✅ **Do**: 
- Use `--autogenerate` flag to auto-detect model changes
- Include all constraints (checks, unique, foreign keys)
- Test migrations on fresh database copy
- Keep migrations clean and focused

❌ **Don't**:
- Manually write migrations if models are correct (use autogenerate)
- Skip testing migrations
- Create migrations for models that aren't finalized
- Forget to run migrations before deployment

---

## After Phase 6 Complete

Next phase priorities:
1. **Phase 7 Frontend Components** - UI for all features
2. **Phase 8 Integration Testing** - Verify all systems work together
3. **Phase 9+ Advanced Features** - Priority queues, equalizer, i18n

---

## Questions/Issues?

If migrations fail:
1. Check SQLAlchemy model definitions are correct
2. Verify Alembic environment is properly configured
3. Check database connection in `alembic.ini`
4. Ensure models are importable: `alembic current` should work without errors

Reference: `backend/alembic/env.py` for environment configuration
